<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K√Ω ·ª©c l√¨ x√¨ 26</title>
    <style>
        body { font-family: 'Courier New', monospace; background-color: #1a1a1a; color: #00ff00; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #2d2d2d; padding: 30px; border: 2px solid #00ff00; border-radius: 10px; width: 400px; box-shadow: 0 0 15px rgba(0,255,0,0.2); }
        
        input, button { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #555; color: white; box-sizing: border-box; }
        button { background: #006400; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #00ff00; color: black; }
        
        .hidden { display: none; }
        .loading { color: yellow; text-align: center; font-size: 14px; margin-bottom: 10px; }
        
        /* CSS cho danh s√°ch ng∆∞·ªùi ch∆°i */
        .user-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px; 
            border-bottom: 1px solid #444; 
            align-items: center; 
        }
        .user-info {
            display: flex;
            flex-direction: column;
        }
        .user-money {
            font-size: 12px;
            color: #ffd700; /* M√†u v√†ng kim lo·∫°i */
            margin-top: 4px;
        }
        .btn-send {
            width: auto; 
            margin: 0; 
            padding: 5px 15px; 
            font-size: 12px;
            background: #007bff;
            border-color: #0056b3;
        }
        .btn-send:hover { background: #3399ff; color: white; }
    </style>
</head>
<body>

<div class="container">

    <div id="loginScreen">
        <h2 style="text-align: center">GAME SERVER</h2>
        <div id="status" class="loading">ƒêang k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß...</div>
        
        <div id="loginForm" class="hidden">
            <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
            <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
            <button onclick="login()">ƒêƒÉng Nh·∫≠p</button>
        </div>
        <button id="btnReload" onclick="loadDataFromCloud()" style="background:#333; border-color:#555">üîÑ T·∫£i l·∫°i d·ªØ li·ªáu</button>
    </div>

    <div id="dashboardScreen" class="hidden">
        <h3>User: <span id="displayName" style="color: white;"></span></h3>
        <h1 style="text-align: center; color: #ffd700; text-shadow: 1px 1px 0 #000;">
            <span id="displayMoney">0</span> $
        </h1>

        <h4>Danh s√°ch ng∆∞·ªùi ch∆°i:</h4>
        <div id="playerList" style="max-height: 300px; overflow-y: auto; border: 1px solid #444;"></div>
        
        <hr style="border-color: #444;">
        <button onclick="logout()" style="background: #b22222; border-color: red;">ƒêƒÉng xu·∫•t</button>
    </div>

</div>

<script>
    // --- C·∫§U H√åNH JSONBIN (ƒêI·ªÄN L·∫†I TH√îNG TIN C·ª¶A B·∫†N V√ÄO ƒê√ÇY) ---
    const BIN_ID = "697120c943b1c97be93fe9ef"; 
    const API_KEY = "$2a$10$ydhdH89Dl8iCYTFsadTlguL.T4QxNH.79JsL62PntdptM1TmcDPKi"; 
    // -------------------------------------------------------------

    let users = [];
    let currentUserIndex = -1;

    // 1. T·∫¢I D·ªÆ LI·ªÜU T·ª™ M·∫†NG
    async function loadDataFromCloud() {
        document.getElementById('status').innerText = "ƒêang t·∫£i d·ªØ li·ªáu...";
        try {
            let req = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                headers: { "X-Master-Key": API_KEY }
            });
            let json = await req.json();
            users = json.record; 
            
            document.getElementById('status').innerText = "M√°y ch·ªß s·∫µn s√†ng!";
            document.getElementById('loginForm').classList.remove('hidden');
        } catch (err) {
            document.getElementById('status').innerText = "L·ªói k·∫øt n·ªëi! Ki·ªÉm tra l·∫°i ID/Key.";
            console.error(err);
        }
    }

    // 2. L∆ØU D·ªÆ LI·ªÜU L√äN M·∫†NG
    async function saveDataToCloud() {
        document.getElementById('status').innerText = "ƒêang l∆∞u giao d·ªãch...";
        try {
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": API_KEY
                },
                body: JSON.stringify(users)
            });
            alert("Chuy·ªÉn ti·ªÅn th√†nh c√¥ng!");
        } catch (err) {
            alert("L·ªói m·∫°ng! S·ªë ti·ªÅn c√≥ th·ªÉ ch∆∞a ƒë∆∞·ª£c l∆∞u.");
        }
    }

    // 3. ƒêƒÇNG NH·∫¨P
    function login() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const index = users.findIndex(user => user.username === u && user.password === p);

        if (index !== -1) {
            currentUserIndex = index;
            showDashboard();
        } else {
            alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!");
        }
    }

    // 4. HI·ªÇN TH·ªä GIAO DI·ªÜN (ƒê√É C·∫¨P NH·∫¨T PH·∫¶N HI·ªÇN TH·ªä TI·ªÄN)
    function showDashboard() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('dashboardScreen').classList.remove('hidden');
        updateUI();
    }

    function updateUI() {
        const me = users[currentUserIndex];
        document.getElementById('displayName').innerText = me.username;
        document.getElementById('displayMoney').innerText = parseInt(me.money).toLocaleString();
        
        const listDiv = document.getElementById('playerList');
        listDiv.innerHTML = "";
        
        users.forEach((user, index) => {
            if (index !== currentUserIndex) {
                // ƒê√ÇY L√Ä PH·∫¶N THAY ƒê·ªîI: Th√™m th·∫ª hi·ªÉn th·ªã s·ªë ti·ªÅn
                listDiv.innerHTML += `
                    <div class="user-item">
                        <div class="user-info">
                            <span style="font-weight:bold">${user.username}</span>
                            <span class="user-money">T√†i s·∫£n: ${parseInt(user.money).toLocaleString()} $</span>
                        </div>
                        <button class="btn-send" onclick="transfer(${index})">G·ª≠i ti·ªÅn</button>
                    </div>`;
            }
        });
    }

    // 5. CHUY·ªÇN TI·ªÄN
    async function transfer(receiverIndex) {
        // T·∫£i l·∫°i data m·ªõi nh·∫•t tr∆∞·ªõc khi chuy·ªÉn ƒë·ªÉ tr√°nh l·ªói s·ªë d∆∞ ·∫£o
        await loadDataFromCloud(); 
        
        // C·∫≠p nh·∫≠t l·∫°i v·ªã tr√≠ ng∆∞·ªùi ch∆°i hi·ªán t·∫°i (ƒë·ªÅ ph√≤ng th·ª© t·ª± m·∫£ng b·ªã thay ƒë·ªïi)
        const currentName = document.getElementById('displayName').innerText;
        currentUserIndex = users.findIndex(u => u.username === currentName);

        const receiver = users[receiverIndex];
        const me = users[currentUserIndex];

        let amount = prompt(`G·ª≠i bao nhi√™u cho ${receiver.username}?`);
        if (!amount) return;
        amount = parseInt(amount);

        if (amount > 0 && amount <= me.money) {
            me.money -= amount;
            receiver.money += amount;
            
            updateUI(); // C·∫≠p nh·∫≠t s·ªë d∆∞ tr√™n m√†n h√¨nh ngay
            await saveDataToCloud(); // ƒê·∫©y l√™n server
        } else {
            alert("S·ªë d∆∞ kh√¥ng ƒë·ªß ho·∫∑c nh·∫≠p sai!");
        }
    }

    function logout() { location.reload(); }

    loadDataFromCloud();
</script>

</body>
</html>