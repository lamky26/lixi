<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√¨ X√¨ T·∫øt Sum V·∫ßy (V8 - Final Custom)</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --red-dark: #8E0000;
            --red-bright: #D32F2F;
            --gold: #FFD700;
            --gold-dark: #B8860B;
            --cream: #FFF8E7;
            --pink-petal: #FFB7C5;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--red-dark);
            background-image: radial-gradient(var(--gold) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--cream);
            margin: 0; padding: 20px; text-align: center;
            min-height: 100vh; box-sizing: border-box;
            overflow-x: hidden;
            position: relative;
        }

        /* --- VISUAL EFFECTS --- */
        .decor-fixed {
            position: fixed;
            z-index: 0;
            pointer-events: none;
            filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.5));
        }
        .lion-bottom-right {
            left: 50%; top: 50%;
            width: auto; height: 100%;
            background-color: transparent;
            object-fit: contain;
            transform: translate(-50%, -50%);
        }

        #petal-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; overflow: hidden;
        }
        .petal {
            position: absolute; top: -20px;
            background: var(--pink-petal);
            border-radius: 150% 0 150% 0;
            animation: fall linear forwards;
            opacity: 0.8; box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        @keyframes fall {
            to { transform: translateY(105vh) rotate(720deg) translateX(50px); opacity: 0; }
        }

        /* --- MAIN CONTAINER --- */
        h1, h2, h3 { font-family: 'Dancing Script', cursive; color: var(--gold); }
        h1 { font-size: 3em; margin-bottom: 10px; text-shadow: 2px 2px 4px #000; }

        .container {
            max-width: 650px; margin: 20px auto;
            background: rgba(162, 159, 159, 0.241);
            padding: 30px; border: 4px solid var(--gold); border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,1);
            position: relative; z-index: 10;
            opacity: 0.92;
        }
        
        .input-group { margin-bottom: 15px; opacity: 10; }
        input {
            padding: 12px; border-radius: 8px; border: 2px solid var(--gold-dark);
            background: var(--cream); color: var(--red-dark);
            font-weight: bold; font-size: 1.1em; width: 80%; text-align: center;
            opacity: 1;
        }
        button {
            background: linear-gradient(to bottom, var(--gold), var(--gold-dark));
            color: var(--red-dark); border: none; padding: 12px 30px;
            font-size: 18px; font-weight: bold; border-radius: 30px;
            cursor: pointer; margin: 10px; box-shadow: 0 5px 0 #8c6608;
            font-family: 'Nunito', sans-serif; transition: all 0.2s;
            opacity: 1;
        }
        button:active { transform: translateY(5px); box-shadow: none; }
        .btn-secondary { background: #fff; color: var(--red-dark); box-shadow: 0 5px 0 #ccc; }

        /* Phong bao & N∆° */
        .envelopes-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; margin-top: 30px; }
        .envelope {
            width: 120px; height: 170px; background: var(--red-bright);
            border: 2px solid var(--gold); border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            padding-bottom: 20px; cursor: pointer; position: relative;
            box-shadow: 0 8px 15px rgba(0,0,0,0.3); transform: translateY(150px); opacity: 0; transition: transform 0.3s; overflow: hidden;
        }
        .ribbon-band { position: absolute; top: 35%; left: 0; width: 100%; height: 15px; background: var(--gold); border-top: 1px solid var(--gold-dark); border-bottom: 1px solid var(--gold-dark); z-index: 1; }
        .bow { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 40px; z-index: 2; pointer-events: none; }
        .bow::before, .bow::after { content: ''; position: absolute; top: 0; width: 40px; height: 40px; background: radial-gradient(circle at center, var(--gold) 40%, var(--gold-dark) 100%); }
        .bow::before { left: 0; border-radius: 50% 0 0 50%; transform: skewY(15deg); }
        .bow::after { right: 0; border-radius: 0 50% 50% 0; transform: skewY(-15deg); }
        .bow-knot { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 15px; height: 15px; background: var(--cream); border-radius: 50%; border: 2px solid var(--gold-dark); z-index: 3; }
        .envelope span { z-index: 3; font-weight: bold; font-size: 1.1em; text-shadow: 1px 1px 2px #000; margin-top: 5px; }
        .envelope:hover { transform: scale(1.05) !important;}
        .envelope.opened { background: var(--cream); color: var(--red-dark); cursor: default; border-color: var(--red-dark); transform: translateY(0) scale(1) !important; }
        .envelope.opened .ribbon-band, .envelope.opened .bow { display: none; }
        .envelope.opened b { font-size: 1.2em; display: block; margin-top: 5px; }

        /* Animation & Modal */
        .fly-in-animation { animation: flyIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes flyIn { to { opacity: 1; transform: translateY(0); } }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: var(--cream); color: var(--red-dark); border: 4px solid var(--gold); padding: 25px; width: 90%; max-width: 450px; border-radius: 15px; text-align: center; }
        .potential-box { background: #fff; border: 2px dashed var(--red-dark); padding: 10px; margin: 15px 0; border-radius: 10px; }
        .potential-amount { font-size: 1.5em; color: var(--gold-dark); font-weight: bold; }
        .challenge-text { font-size: 1.3em; font-weight: bold; padding: 15px; background: rgba(255, 215, 0, 0.2); border-radius: 10px; margin: 15px 0; }
        .voting-area { text-align: left; margin-top: 15px; max-height: 200px; overflow-y: auto; padding: 10px; background: #fff; border-radius: 8px;}
        .vote-row { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; font-weight: bold;}
        #result-list li { background: rgba(255, 215, 0, 0.2); margin: 8px 0; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .money-highlight { color: var(--gold); font-weight: bold; font-size: 1.4em; font-family: 'Dancing Script';}
    </style>
</head>
<body>

<video src="conlan.mp4" class="decor-fixed lion-bottom-right" autoplay loop muted></video>

<div id="petal-container"></div>

<div class="container">
    <div id="screen-intro" class="screen active">
        <h1>üßß L√¨ X√¨ ƒê·∫ßu Xu√¢n üßß</h1>
        <div id="player-inputs">
            <div class="input-group"><input type="text" placeholder="T√™n ng∆∞·ªùi ch∆°i 1..."></div>
            <div class="input-group"><input type="text" placeholder="T√™n ng∆∞·ªùi ch∆°i 2..."></div>
        </div>
        <button onclick="addPlayerField()">‚ûï Th√™m ng∆∞·ªùi ch∆°i</button>
        <br><br>
        <button style="font-size: 22px; padding: 15px 40px;" onclick="startGame()">V√†o nh·∫≠n l√¨ x√¨ th√¥i! ‚ñ∂</button>
    </div>

    <div id="screen-game" class="screen">
        <h2>Ch·ªçn H·ªôp Qu√† May M·∫Øn</h2>
        <div class="envelopes-area" id="envelopes-area"></div>
    </div>

    <div id="screen-result" class="screen">
        <h1>üéâ T·ªïng K·∫øt L√¨ X√¨ üéâ</h1>
        <h3 id="random-wish" style="color: var(--cream); font-style: italic;"></h3>
        <ul id="result-list" style="list-style: none; padding: 0;"></ul>
        
        <div style="margin-top: 20px;">
            <button class="btn-secondary" onclick="downloadResultTxt()">üì• T·∫£i k·∫øt qu·∫£ (.txt)</button>
            <button onclick="location.reload()">üîÑ Ch∆°i l·∫°i</button>
        </div>
    </div>
</div>

<div id="modal-challenge" class="modal">
    <div class="modal-content">
        <h3 id="challenge-title">TH·ª¨ TH√ÅCH</h3>
        
        <div id="challenge-content-area"></div>

        <div id="potential-display" class="potential-box" style="display:none;">
            <div>B·∫°n c√≥ th·ªÉ nh·∫≠n th√™m:</div>
            <div class="potential-amount">1.000 - 30.000 ƒë</div>
        </div>
        
        <div id="voting-section" style="display:none;">
            <hr>
            <p>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ch·∫•m ƒëi·ªÉm (Thang 10):</p>
            <div id="voters-list" class="voting-area"></div>
        </div>

        <button id="btn-challenge-action" onclick="handleChallengeAction()">Ho√†n th√†nh</button>
    </div>
</div>

<script>
    // --- SCRIPT HI·ªÜU ·ª®NG HOA R∆†I ---
    function createPetal() {
        const petalContainer = document.getElementById('petal-container');
        const petal = document.createElement('div');
        petal.classList.add('petal');
        const startLeft = Math.random() * window.innerWidth;
        const size = Math.random() * 10 + 10; 
        const duration = Math.random() * 3 + 4;
        petal.style.left = startLeft + 'px';
        petal.style.width = size + 'px';
        petal.style.height = size + 'px';
        petal.style.animationDuration = duration + 's';
        petalContainer.appendChild(petal);
        setTimeout(() => { petal.remove(); }, duration * 1000);
    }
    setInterval(createPetal, 300);


    // --- SCRIPT GAME LOGIC ---
    const emotionalChallenges = [
        "√îm ng∆∞·ªùi b√™n tr√°i th·∫≠t ch·∫∑t trong 10s.", "Khen ng·ª£i 3 ng∆∞·ªùi trong ph√≤ng.",
        "Ch√∫c t·∫øt ng∆∞·ªùi l·ªõn tu·ªïi nh·∫•t.", "Nh·∫Øn tin 'Con y√™u B·ªë/M·∫π' ngay.",
        "K·ªÉ k·ª∑ ni·ªám vui v·ªõi ng∆∞·ªùi ƒë·ªëi di·ªán.", "B·∫Øt tay ch√∫c t·∫øt t·ª´ng ng∆∞·ªùi."
    ];
    const funnyChallenges = [
        "M√∫a qu·∫°t/Nh·∫£y Tiktok.", "L√†m m·∫∑t x·∫•u 10s ch·ª•p ·∫£nh.",
        "V·ª´a nh·∫£y l√≤ c√≤ v·ª´a h√°t.", "Gi·∫£ ti·∫øng m√®o ch√∫c t·∫øt.",
        "ƒêi catwalk.", "Gi·ªØ th√¨a tr√™n m≈©i 10s."
    ];
    const wishes = [
        "Ti·ªÅn v√†o nh∆∞ n∆∞·ªõc s√¥ng ƒê√†!", "V·∫°n s·ª± nh∆∞ √Ω, t·ª∑ s·ª± nh∆∞ m∆°!", 
        "S·ª©c kh·ªèe v√¥ bi√™n, ki·∫øm ƒë∆∞·ª£c nhi·ªÅu ti·ªÅn!", "T·∫•n t√†i t·∫•n l·ªôc t·∫•n b√¨nh an."
    ];

    let players = [];
    let currentPlayerIndex = -1;

    function addPlayerField() {
        const div = document.createElement('div');
        div.className = 'input-group';
        div.innerHTML = `<input type="text" placeholder="T√™n ng∆∞·ªùi ch∆°i ${document.querySelectorAll('#player-inputs input').length + 1}...">`;
        document.getElementById('player-inputs').appendChild(div);
    }

    function startGame() {
        const inputs = document.querySelectorAll('#player-inputs input');
        players = [];
        inputs.forEach(input => {
            if (input.value.trim() !== "") players.push({ name: input.value.trim(), initialMoney: 0, finalMoney: 0, completed: false });
        });
        if (players.length < 1) return alert("Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi ch∆°i!");
        
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-game').classList.add('active');
        renderEnvelopes();
    }

    function renderEnvelopes() {
        const area = document.getElementById('envelopes-area');
        area.innerHTML = '';
        players.forEach((player, index) => {
            const env = document.createElement('div');
            env.className = 'envelope';
            setTimeout(() => { env.classList.add('fly-in-animation'); }, index * 150);
            
            if (!player.completed) {
                env.innerHTML = `<div class="ribbon-band"></div><div class="bow"><div class="bow-knot"></div></div><span>${player.name}</span>`;
                env.onclick = () => openEnvelope(index);
            } else {
                env.classList.add('opened', 'fly-in-animation');
                // Hi·ªÉn th·ªã ƒë∆°n v·ªã 000 ƒë
                env.innerHTML = `<span>${player.name}</span><b>${player.finalMoney}.000 ƒë</b>`;
            }
            area.appendChild(env);
        });
    }

    function openEnvelope(index) {
        currentPlayerIndex = index;
        const player = players[index];

        // --- C·∫¨P NH·∫¨T T·ª∂ L·ªÜ M·ªöI ---
        let money;
        const chance = Math.random(); // 0.0 - 1.0
        
        if (chance <= 0.02) { 
            // 2% c∆° h·ªôi: Ti·ªÅn Cao (50 - 60)
            money = Math.floor(Math.random() * (60 - 50 + 1)) + 50;
        } else if (chance <= 0.22) { // 2% + 20% = 22%
            // 20% c∆° h·ªôi: Ti·ªÅn V·ª´a (40 - 49)
            money = Math.floor(Math.random() * (49 - 40 + 1)) + 40;
        } else {
            // C√≤n l·∫°i (78%): Ti·ªÅn Th·∫•p (1 - 39) -> V√†o Challenge
            money = Math.floor(Math.random() * (39 - 1 + 1)) + 1;
        }

        player.initialMoney = money;
        player.finalMoney = money; 
        
        document.body.style.backgroundColor = "#FFFACD";
        setTimeout(() => { document.body.style.backgroundColor = ""; }, 150);

        // Logic Modal hi·ªÉn th·ªã
        if (money < 40) {
            // Nh√≥m Th·∫•p (1-39): B·∫Øt bu·ªôc Challenge
            showModal("C∆† H·ªòI L·ªòI NG∆Ø·ª¢C D√íNG", 
                `B·∫°n b·ªëc ƒë∆∞·ª£c <b>${money}.000 ƒë</b>. H∆°i √≠t nh·ªâ?`, 
                true, "challenge");
        } else if (money >= 50) {
            // Nh√≥m Cao (50-60): Th·ª≠ th√°ch vui v·∫ª
            const challenge = funnyChallenges[Math.floor(Math.random() * funnyChallenges.length)];
            showModal("L·ªòC L·ªöN PH·∫¢I T·∫¨N H∆Ø·ªûNG", 
                `Ch√∫c m·ª´ng! B·∫°n b·ªëc ƒë∆∞·ª£c t·∫≠n <b>${money}.000 ƒë</b>.<br>Th·ª±c hi·ªán th·ª≠ th√°ch n√†y ƒë·ªÉ nh·∫≠n ti·ªÅn:`, 
                false, "funny", challenge);
        } else {
            // Nh√≥m V·ª´a (40-49): Nh·∫≠n lu√¥n
            alert(`Ch√∫c m·ª´ng ${player.name} nh·∫≠n ƒë∆∞·ª£c ${money}.000 ƒë!`);
            player.completed = true;
            checkEndGame();
        }
    }

    function showModal(title, introText, isVoting, type, specificContent = null) {
        const modal = document.getElementById('modal-challenge');
        document.getElementById('challenge-title').innerText = title;
        document.getElementById('challenge-content-area').innerHTML = `<p>${introText}</p>` + (specificContent ? `<div class="challenge-text">${specificContent}</div>` : '');
        
        const votingSection = document.getElementById('voting-section');
        const potentialDisplay = document.getElementById('potential-display');
        const btn = document.getElementById('btn-challenge-action');
        
        votingSection.style.display = 'none';
        
        if (type === "challenge") {
            potentialDisplay.style.display = 'block';
            btn.innerText = "üî• Ch·∫•p nh·∫≠n th·ª≠ th√°ch!";
        } else {
            potentialDisplay.style.display = 'none';
            btn.innerText = "‚úÖ ƒê√£ xong, nh·∫≠n ti·ªÅn!";
        }

        btn.onclick = () => handleChallengeAction(type);
        modal.style.display = 'flex';
    }

    function handleChallengeAction(type) {
        if (type === "challenge") {
            const challenge = emotionalChallenges[Math.floor(Math.random() * emotionalChallenges.length)];
            document.getElementById('challenge-content-area').innerHTML = `<p>Th·ª≠ th√°ch c·ªßa b·∫°n l√†:</p><div class="challenge-text">${challenge}</div>`;
            document.getElementById('potential-display').style.display = 'none'; 

            const votersDiv = document.getElementById('voters-list');
            votersDiv.innerHTML = '';
            const otherPlayers = players.filter((_, i) => i !== currentPlayerIndex);
            
            if (otherPlayers.length === 0) votersDiv.innerHTML = "<i>M√°y t·ª± ch·∫•m 10 ƒëi·ªÉm!</i>";
            else {
                otherPlayers.forEach(p => {
                    votersDiv.innerHTML += `
                        <div class="vote-row"><span>${p.name}:</span>
                        <select class="vote-score">
                            <option value="10">10 (Tuy·ªát v·ªùi)</option><option value="9">9 (Tuy·ªát)</option>
                            <option value="8">8 (T·ªët)</option><option value="7">7 (kh√°)</option>
                            <option value="6">6 (C≈©ng ƒëk)</option><option value="5">5 (T·∫°m)</option>
                            <option value="4">4 (ch√°n ƒë·ªùi)</option><option value="3">3 (ƒëi ·ªâa m∆∞·ª£t h∆°n)</option>
                            <option value="2">2 (·∫πc)</option><option value="1">1 (kh·ªèi ch·∫•m bay ∆°i)</option>
                        </select></div>`;
                });
            }
            document.getElementById('voting-section').style.display = 'block';
            const btn = document.getElementById('btn-challenge-action');
            btn.innerText = "Ch·∫•m ƒëi·ªÉm & Nh·∫≠n th∆∞·ªüng";
            btn.onclick = calculateChallengeResult;
        } else {
            players[currentPlayerIndex].completed = true;
            document.getElementById('modal-challenge').style.display = 'none';
            checkEndGame();
        }
    }

    function calculateChallengeResult() {
        const scores = document.querySelectorAll('.vote-score');
        let total = 0, count = 0;
        if (scores.length === 0) { total = 10; count = 1; }
        else { scores.forEach(s => { total += parseInt(s.value); count++; }); }
        
        const avg = total / count;
        
        // --- TH∆Ø·ªûNG TH√äM T·ª™ 1 ƒê·∫æN 30 ---
        const bonus = Math.round((Math.floor(Math.random() * 30) + 1) * (avg / 10));
        
        players[currentPlayerIndex].finalMoney += bonus;
        
        alert(`ƒêi·ªÉm TB: ${avg.toFixed(1)}/10. Th∆∞·ªüng th√™m: ${bonus}.000 ƒë.\nT·ªîNG: ${players[currentPlayerIndex].finalMoney}.000 ƒë`);
        players[currentPlayerIndex].completed = true;
        document.getElementById('modal-challenge').style.display = 'none';
        checkEndGame();
    }

    function checkEndGame() {
        renderEnvelopes();
        if (players.every(p => p.completed && players.length > 0)) {
            setTimeout(() => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('screen-result').classList.add('active');
                
                const list = document.getElementById('result-list');
                list.innerHTML = '';
                document.getElementById('random-wish').innerText = `"${wishes[Math.floor(Math.random() * wishes.length)]}"`;
                
                [...players].sort((a, b) => b.finalMoney - a.finalMoney).forEach((p, i) => {
                    let rank = i === 0 ? 'ü•á' : (i === 1 ? 'ü•à' : 'üéóÔ∏è');
                    list.innerHTML += `<li><span>${rank} <b>${p.name}</b></span> <span class="money-highlight">${p.finalMoney}.000 ƒë</span></li>`;
                });
            }, 1200);
        }
    }

    function downloadResultTxt() {
        const wish = document.getElementById('random-wish').innerText;
        let content = "=== üßß K·∫æT QU·∫¢ L√å X√å T·∫æT SUM V·∫¶Y üßß ===\n\n";
        content += `L·ªùi ch√∫c: ${wish}\n\n`;
        content += "--- B·∫¢NG X·∫æP H·∫†NG ---\n";
        
        [...players].sort((a, b) => b.finalMoney - a.finalMoney).forEach((p, i) => {
            content += `${i+1}. ${p.name}: ${p.finalMoney}.000 ƒë\n`;
        });
        
        content += "\n--- Happy New Year ---";

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ket_qua_lixi_tet.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>