<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√¨ X√¨ T·∫øt Sum V·∫ßy Online (V3)</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --red-dark: #8E0000;
            --red-bright: #D32F2F;
            --gold: #FFD700;
            --gold-dark: #B8860B;
            --cream: #FFF8E7;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--red-dark);
            background-image: radial-gradient(var(--gold) 1px, transparent 1px), radial-gradient(var(--gold) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
            color: var(--cream);
            margin: 0; padding: 20px; text-align: center;
            min-height: 100vh; box-sizing: border-box;
        }
        h1, h2, h3 { font-family: 'Dancing Script', cursive; color: var(--gold); }
        h1 { font-size: 3em; margin-bottom: 10px; text-shadow: 2px 2px 4px #000; }

        .container {
            max-width: 650px; margin: 20px auto;
            background: rgba(142, 0, 0, 0.9);
            padding: 30px; border: 4px solid var(--gold); border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }
        
        .input-group { margin-bottom: 15px; }
        input {
            padding: 12px; border-radius: 8px; border: 2px solid var(--gold-dark);
            background: var(--cream); color: var(--red-dark);
            font-weight: bold; font-size: 1.1em; width: 80%; text-align: center;
        }
        button {
            background: linear-gradient(to bottom, var(--gold), var(--gold-dark));
            color: var(--red-dark); border: none; padding: 12px 30px;
            font-size: 18px; font-weight: bold; border-radius: 30px;
            cursor: pointer; margin: 10px; box-shadow: 0 5px 0 #8c6608;
            font-family: 'Nunito', sans-serif; transition: all 0.2s;
        }
        button:active { transform: translateY(5px); box-shadow: none; }

        /* --- ENVELOPE STYLES & BOW (CHI·∫æC N∆†) --- */
        .envelopes-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; margin-top: 30px; }
        
        .envelope {
            width: 120px; height: 170px;
            background: var(--red-bright);
            border: 2px solid var(--gold); border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            padding-bottom: 20px;
            cursor: pointer; position: relative;
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
            transform: translateY(150px); opacity: 0;
            transition: transform 0.3s;
            overflow: hidden; /* ƒê·ªÉ c·∫Øt ph·∫ßn n∆° th·ª´a n·∫øu c√≥ */
        }
        
        /* D·∫£i d√¢y ngang */
        .ribbon-band {
            position: absolute; top: 35%; left: 0; width: 100%; height: 15px;
            background: var(--gold);
            border-top: 1px solid var(--gold-dark); border-bottom: 1px solid var(--gold-dark);
            z-index: 1;
        }
        
        /* T·∫°o h√¨nh chi·∫øc n∆° b·∫±ng CSS */
        .bow {
            position: absolute; top: 35%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80px; height: 40px;
            z-index: 2; pointer-events: none;
        }
        /* C√°nh n∆° tr√°i */
        .bow::before {
            content: ''; position: absolute; left: 0; top: 0;
            width: 40px; height: 40px;
            background: radial-gradient(circle at center, var(--gold) 40%, var(--gold-dark) 100%);
            border-radius: 50% 0 0 50%;
            transform: skewY(15deg);
            box-shadow: -2px 2px 2px rgba(0,0,0,0.2);
        }
        /* C√°nh n∆° ph·∫£i */
        .bow::after {
            content: ''; position: absolute; right: 0; top: 0;
            width: 40px; height: 40px;
            background: radial-gradient(circle at center, var(--gold) 40%, var(--gold-dark) 100%);
            border-radius: 0 50% 50% 0;
            transform: skewY(-15deg);
            box-shadow: 2px 2px 2px rgba(0,0,0,0.2);
        }
        /* N√∫t th·∫Øt gi·ªØa n∆° */
        .bow-knot {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 15px; height: 15px;
            background: var(--cream);
            border-radius: 50%;
            border: 2px solid var(--gold-dark);
            z-index: 3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .envelope span { z-index: 3; font-weight: bold; font-size: 1.1em; text-shadow: 1px 1px 2px #000; margin-top: 5px; }
        .envelope:hover { transform: scale(1.05) !important;}

        .envelope.opened {
            background: var(--cream); color: var(--red-dark); cursor: default; border-color: var(--red-dark);
            transform: translateY(0) scale(1) !important;
        }
        .envelope.opened .ribbon-band, .envelope.opened .bow, .envelope.opened .bow-knot { display: none; } /* ·∫®n n∆° khi m·ªü */
        .envelope.opened span { margin-top: 0; text-shadow: none; color: var(--red-dark); font-size: 1.3em;}

        /* Animations & Modals */
        .fly-in-animation { animation: flyIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes flyIn { to { opacity: 1; transform: translateY(0); } }
        
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }
        .modal-content {
            background: var(--cream); color: var(--red-dark); border: 4px solid var(--gold);
            padding: 25px; width: 90%; max-width: 450px; border-radius: 15px; text-align: center;
        }
        .challenge-text {
            font-size: 1.3em; font-weight: bold; padding: 15px; background: rgba(255, 215, 0, 0.2); border-radius: 10px; margin: 15px 0;
        }
        .voting-area { text-align: left; margin-top: 15px; max-height: 200px; overflow-y: auto; padding: 10px; background: #fff; border-radius: 8px;}
        .vote-row { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; font-weight: bold;}
        
        #result-list li {
            background: rgba(255, 215, 0, 0.2); margin: 8px 0; padding: 10px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .money-highlight { color: var(--gold); font-weight: bold; font-size: 1.4em; font-family: 'Dancing Script';}
    </style>
</head>
<body>

<div class="container">
    <div id="screen-intro" class="screen active">
        <h1>üßß L√¨ X√¨ ƒê·∫ßu Xu√¢n üßß</h1>
        <div id="player-inputs">
            <div class="input-group"><input type="text" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i 1..."></div>
            <div class="input-group"><input type="text" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i 2..."></div>
        </div>
        <button onclick="addPlayerField()">‚ûï Th√™m ng∆∞·ªùi ch∆°i</button>
        <br><br>
        <button style="font-size: 22px; padding: 15px 40px;" onclick="startGame()">V√†o nh·∫≠n l√¨ x√¨ th√¥i! ‚ñ∂</button>
    </div>

    <div id="screen-game" class="screen">
        <h2>Ch·ªçn H·ªôp Qu√† May M·∫Øn</h2>
        <div class="envelopes-area" id="envelopes-area"></div>
    </div>

    <div id="screen-result" class="screen">
        <h1>üéâ T·ªïng K·∫øt L√¨ X√¨ üéâ</h1>
        <h3 id="random-wish" style="color: var(--cream); font-style: italic;"></h3>
        <ul id="result-list" style="list-style: none; padding: 0;"></ul>
        <button onclick="location.reload()">Ch∆°i l·∫°i t·ª´ ƒë·∫ßu üîÑ</button>
    </div>
</div>

<div id="modal-challenge" class="modal">
    <div class="modal-content">
        <h3 id="challenge-title">TH·ª¨ TH√ÅCH</h3>
        <div id="challenge-content-area"></div>
        
        <div id="voting-section" style="display:none;">
            <hr>
            <p>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ch·∫•m ƒëi·ªÉm (Thang 10):</p>
            <div id="voters-list" class="voting-area"></div>
        </div>

        <button id="btn-challenge-action" onclick="handleChallengeAction()">Ho√†n th√†nh</button>
    </div>
</div>

<script>
    const emotionalChallenges = [
        "√îm ng∆∞·ªùi b√™n tr√°i th·∫≠t ch·∫∑t trong 10s.", "Khen ng·ª£i ki·ªÉu t√≥c/trang ph·ª•c c·ªßa 3 ng∆∞·ªùi.",
        "N√≥i l·ªùi c·∫£m ∆°n ch√¢n th√†nh t·ªõi ng∆∞·ªùi l·ªõn tu·ªïi nh·∫•t.", "Nh·∫Øn tin 'Con y√™u B·ªë/M·∫π' ngay l·∫≠p t·ª©c.",
        "K·ªÉ m·ªôt k·ª∑ ni·ªám vui v·ªõi ng∆∞·ªùi ng·ªìi ƒë·ªëi di·ªán.", "B·∫Øt tay ch√∫c t·∫øt t·ª´ng ng∆∞·ªùi trong ph√≤ng."
    ];
    const funnyChallenges = [
        "M√∫a qu·∫°t ho·∫∑c nh·∫£y Trend Tiktok b·∫•t k·ª≥.", "L√†m m·∫∑t x·∫•u trong 10s ƒë·ªÉ m·ªçi ng∆∞·ªùi ch·ª•p ·∫£nh.",
        "V·ª´a nh·∫£y l√≤ c√≤ v·ª´a h√°t 'Happy New Year'.", "Gi·∫£ ti·∫øng m√®o k√™u ch√∫c t·∫øt m·ªçi ng∆∞·ªùi.",
        "ƒêi catwalk t·ª´ ƒë·∫ßu ph√≤ng ƒë·∫øn cu·ªëi ph√≤ng.", "Gi·ªØ thƒÉng b·∫±ng c√°i th√¨a tr√™n m≈©i 10s."
    ];
    const wishes = [
        "Ti·ªÅn v√†o nh∆∞ n∆∞·ªõc s√¥ng ƒê√†!", "V·∫°n s·ª± nh∆∞ √Ω, t·ª∑ s·ª± nh∆∞ m∆°!", 
        "S·ª©c kh·ªèe v√¥ bi√™n, ki·∫øm ƒë∆∞·ª£c nhi·ªÅu ti·ªÅn!", "T·∫•n t√†i t·∫•n l·ªôc t·∫•n b√¨nh an."
    ];

    let players = [];
    let currentPlayerIndex = -1;

    function addPlayerField() {
        const div = document.createElement('div');
        div.className = 'input-group';
        div.innerHTML = `<input type="text" placeholder="T√™n ng∆∞·ªùi ch∆°i ${document.querySelectorAll('#player-inputs input').length + 1}...">`;
        document.getElementById('player-inputs').appendChild(div);
    }

    function startGame() {
        const inputs = document.querySelectorAll('#player-inputs input');
        players = [];
        inputs.forEach(input => {
            if (input.value.trim() !== "") players.push({ name: input.value.trim(), initialMoney: 0, finalMoney: 0, completed: false });
        });
        if (players.length < 1) return alert("Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi ch∆°i!");
        
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-game').classList.add('active');
        renderEnvelopes();
    }

    function renderEnvelopes() {
        const area = document.getElementById('envelopes-area');
        area.innerHTML = '';
        players.forEach((player, index) => {
            const env = document.createElement('div');
            env.className = 'envelope';
            setTimeout(() => { env.classList.add('fly-in-animation'); }, index * 150);
            
            if (!player.completed) {
                // Render n∆° v√† d√¢y
                env.innerHTML = `
                    <div class="ribbon-band"></div>
                    <div class="bow"><div class="bow-knot"></div></div>
                    <span>${player.name}</span>
                `;
                env.onclick = () => openEnvelope(index);
            } else {
                env.classList.add('opened', 'fly-in-animation');
                env.innerHTML = `<span>${player.name}</span><b style="font-size:1.4em">${player.finalMoney}k</b>`;
            }
            area.appendChild(env);
        });
    }

    function openEnvelope(index) {
        currentPlayerIndex = index;
        const player = players[index];

        // --- LOGIC X√ÅC SU·∫§T M·ªöI (10% c∆° h·ªôi cho 85-100) ---
        let money;
        const chance = Math.random(); // 0.0 - 1.0
        
        if (chance <= 0.10) { 
            // 10% c∆° h·ªôi r∆°i v√†o kho·∫£ng 85 - 100
            money = Math.floor(Math.random() * (100 - 85 + 1)) + 85;
        } else {
            // 90% c∆° h·ªôi r∆°i v√†o kho·∫£ng 1 - 84
            money = Math.floor(Math.random() * 84) + 1;
        }

        player.initialMoney = money;
        player.finalMoney = money; 
        
        // Hi·ªáu ·ª©ng ch·ªõp
        document.body.style.backgroundColor = "#FFFACD";
        setTimeout(() => { document.body.style.backgroundColor = ""; }, 150);

        // --- LU·∫¨T CH∆†I M·ªöI (< 35 ƒê∆Ø·ª¢C CHALLENGE) ---
        if (money < 35) {
            // Case Th·∫•p: ƒê∆∞·ª£c quy·ªÅn th·ª≠ th√°ch
            showModal("C∆† H·ªòI L·ªòI NG∆Ø·ª¢C D√íNG", 
                `B·∫°n b·ªëc ƒë∆∞·ª£c <b>${money} VND</b>. <br>H∆°i √≠t nh·ªâ? B·∫°n c√≥ mu·ªën l√†m th·ª≠ th√°ch ƒë·ªÉ nh·∫≠n th√™m ti·ªÅn kh√¥ng?`, 
                true, "challenge");
        } else if (money >= 85) {
            // Case Cao: B·∫Øt bu·ªôc th·ª≠ th√°ch
            const challenge = funnyChallenges[Math.floor(Math.random() * funnyChallenges.length)];
            showModal("L·ªòC L·ªöN PH·∫¢I T·∫¨N H∆Ø·ªûNG", 
                `Ch√∫c m·ª´ng! B·∫°n b·ªëc ƒë∆∞·ª£c t·∫≠n <b>${money} VND</b>.<br>Th·ª±c hi·ªán ngay th·ª≠ th√°ch vui n√†y ƒë·ªÉ nh·∫≠n ti·ªÅn:`, 
                false, "funny", challenge);
        } else {
            // Case Trung b√¨nh
            alert(`Ch√∫c m·ª´ng ${player.name} nh·∫≠n ƒë∆∞·ª£c ${money} VND!`);
            player.completed = true;
            checkEndGame();
        }
    }

    function showModal(title, introText, isVoting, type, specificContent = null) {
        const modal = document.getElementById('modal-challenge');
        document.getElementById('challenge-title').innerText = title;
        document.getElementById('challenge-content-area').innerHTML = `<p>${introText}</p>` + (specificContent ? `<div class="challenge-text">${specificContent}</div>` : '');
        
        const votingSection = document.getElementById('voting-section');
        const btn = document.getElementById('btn-challenge-action');
        votingSection.style.display = 'none';
        
        btn.onclick = () => handleChallengeAction(type);
        btn.innerText = type === "challenge" ? "üî• Ch·∫•p nh·∫≠n th·ª≠ th√°ch!" : "‚úÖ ƒê√£ xong, nh·∫≠n ti·ªÅn!";
        modal.style.display = 'flex';
    }

    function handleChallengeAction(type) {
        if (type === "challenge") {
            const challenge = emotionalChallenges[Math.floor(Math.random() * emotionalChallenges.length)];
            document.getElementById('challenge-content-area').innerHTML = `<p>Th·ª≠ th√°ch c·ªßa b·∫°n l√†:</p><div class="challenge-text">${challenge}</div>`;
            
            const votersDiv = document.getElementById('voters-list');
            votersDiv.innerHTML = '';
            const otherPlayers = players.filter((_, i) => i !== currentPlayerIndex);
            
            if (otherPlayers.length === 0) votersDiv.innerHTML = "<i>Ch∆°i m·ªôt m√¨nh th√¨ m√°y t·ª± ch·∫•m 10 ƒëi·ªÉm nh√©!</i>";
            else {
                otherPlayers.forEach(p => {
                    votersDiv.innerHTML += `
                        <div class="vote-row"><span>${p.name}:</span>
                        <select class="vote-score">
                            <option value="10">10 (Tuy·ªát v·ªùi)</option><option value="9">9 (Tuy·ªát)</option>
                            <option value="8">8 (T·ªët)</option><option value="7">7 (kh√°)</option>
                            <option value="6">6 (C≈©ng ƒëk)</option><option value="5">5 (T·∫°m)</option>
                            <option value="4">4 (ch√°n ƒë·ªùi)</option><option value="3">3 (ƒëi ·ªâa m∆∞·ª£t h∆°n)</option>
                            <option value="2">2 (·∫πc)</option><option value="1">1 (kh·ªèi ch·∫•m bay ∆°i)</option>
                        </select></div>`;
                });
            }
            document.getElementById('voting-section').style.display = 'block';
            const btn = document.getElementById('btn-challenge-action');
            btn.innerText = "Ch·∫•m ƒëi·ªÉm & Nh·∫≠n th∆∞·ªüng";
            btn.onclick = calculateChallengeResult;
        } else {
            players[currentPlayerIndex].completed = true;
            document.getElementById('modal-challenge').style.display = 'none';
            checkEndGame();
        }
    }

    function calculateChallengeResult() {
        const scores = document.querySelectorAll('.vote-score');
        let total = 0, count = 0;
        if (scores.length === 0) { total = 10; count = 1; }
        else { scores.forEach(s => { total += parseInt(s.value); count++; }); }
        
        const avg = total / count;
        const bonus = Math.round((Math.floor(Math.random() * 50) + 1) * (avg / 10));
        players[currentPlayerIndex].finalMoney += bonus;
        
        alert(`ƒêi·ªÉm TB: ${avg.toFixed(1)}/10. Th∆∞·ªüng th√™m: ${bonus} VND.\nT·ªîNG: ${players[currentPlayerIndex].finalMoney} VND`);
        players[currentPlayerIndex].completed = true;
        document.getElementById('modal-challenge').style.display = 'none';
        checkEndGame();
    }

    function checkEndGame() {
        renderEnvelopes();
        if (players.every(p => p.completed && players.length > 0)) {
            setTimeout(() => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('screen-result').classList.add('active');
                
                const list = document.getElementById('result-list');
                list.innerHTML = '';
                document.getElementById('random-wish').innerText = `"${wishes[Math.floor(Math.random() * wishes.length)]}"`;
                
                [...players].sort((a, b) => b.finalMoney - a.finalMoney).forEach((p, i) => {
                    let rank = i === 0 ? 'ü•á' : (i === 1 ? 'ü•à' : 'üéóÔ∏è');
                    list.innerHTML += `<li><span>${rank} <b>${p.name}</b></span> <span class="money-highlight">${p.finalMoney} VND</span></li>`;
                });
            }, 1200);
        }
    }
</script>

</body>
</html>